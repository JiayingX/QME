---
title: 'CTT analysis for test: `r thistest$test_name`'
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
  word_document: default
date: "Generated `r date()`"
---



**Number of items:** `r x$test_level$descriptives$number_items`

**Number of examinees:** `r x$test_level$descriptives$number_examinees`


## Total score information

```{r totalscores, echo = FALSE, message=FALSE}
test_info_out(x)
```


## Reliability

```{r reliability, echo = FALSE}
x$test_level$reliability
x$item_level$del_alphas
```

*Brief notes about reliability assumptions here.*

## Item overview

```{r item_overview, echo = FALSE, results='asis'}
overview = data.frame(x$item_level$item_stats, x$item_level$missing)
names(overview) = c("Difficulty", "PBiS", "Corrected PBiS", "Missing (N)", "Missing (p)")

knitr::kable(overview, digits = 2)

```

```{r item_participant_plot, message=FALSE, echo=FALSE}

basicdf = as.data.frame(mybasics)
basicdf$item = rownames(basicdf)

basicdf$difficultybin = findInterval(basicdf$difficulty, (0:10)/10)/10 - 0.05

ggplot(basicdf, aes(difficultybin,
                    y = 1,
                    label = item)) + 
  geom_text(position = "stack") + 
  scale_y_continuous("Number of items") +
  scale_x_continuous("Difficulty") +
  coord_cartesian(xlim = c(0, 1)) +
  coord_flip() +
  ggtitle("Item Difficulties")


```



## Item details

```{r itemloop_prep, echo = FALSE, message = FALSE}

getTerciles = function(x) {
  ## Input odin_zeus, output long df with terciles & proportions

keyed = getKeyedTestNoID(x$test)
raw = getRawTestNoID(x$test)

delscores = scores$scores - keyed

## Calculate deleted terciles
terciles = sapply(delscores, function(x)
  findInterval(x, 
               quantile(x, probs = c(0, 1/3, 2/3, 1)),
               all.inside = TRUE)
  )

## Calculate proportion choosing each distractor

tercsummary = melt(terciles) %>% 
  rename(tercile = value) %>% 
  left_join(melt(as.matrix(raw)) %>%
              rename(response = value)) %>%
  rename(id = Var1, item = Var2) %>%
  group_by(item, tercile, response) %>%
  summarize(count = n()) %>%
  group_by(item, tercile) %>%
  mutate(total = sum(count),
         prop = count/total) %>%
  ungroup() %>%
  mutate(tercile = ordered(tercile, labels = 
                            c("Low", "Medium", "High")))

  tercsummary
}

```

### Item 1
Domain: `XX`

```{r itemloop_fun, echo = F, warning=FALSE, message=FALSE}


x = thistest
tercsummary = getTerciles(x)

itemnum = 1

thisitem = item_names(x)[itemnum]


this = tercsummary[tercsummary$item %in% thisitem,]

fillzeros = with(this, 
     expand.grid(unique(item), unique(tercile), unique(response))) %>%
  set_names(names(tercsummary)[1:3]) %>%
  mutate(count = 0,
         total = 0,
         prop = 0)

thisfull = rbind(this, 
      fillzeros %>% 
        anti_join(this, by = c("item", "tercile", "response")))

      
  theplot = ggplot(thisfull, aes(x = tercile, y = prop, group = response,
                       colour = response)) +
    geom_line() +
  geom_point() + 
  ggtitle("Distractors by tercile")

```

*(these numbers are made up, the package does not yet easily provide the correlation with corrected total or more sophisticated keys)*

| Choice | Key | Proportion | Cor w/ Corrected Total| 
|---:|----:|----:|----:|
|A|0|0.3|-.2|
|D|0|0.47|.02|
|E|1|0.3|.3|

`XX` missing values out of `XX` examinees (`XX` %).

### Item 2
... and so on



